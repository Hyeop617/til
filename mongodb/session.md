# 세션

mongoDB에서 세션은 서버 세션과 클라이언트 세션이 있음.<br>

## 서버 세션
서버 세션은 mongoDB 인스턴스와 클라이언트(DBMS, 서버 애플리케이션 등)가 연결될 때 생성되는 세션임.<br>
서버 세션은 클라이언트 세션과 1:1로 매핑됨. 클라이언트 세션을 생성하면 그에 대응하는 서버 세션이 서버 측에 생성됨.<br>
그리고 연결된 세션은 클라이언트에서 계속 유지되며, 샤드 클러스터나 레플리카 셋에서도 같은 세션이 유지됨.<br>

## 클라이언트 세션
인과적 일관성(causal consistency)를 도입하기 위해 mongoDB 3.6부터 클라이언트 세션이 도입됨.<br>
예를 들어 클라이언트가 데이터를 수정한 뒤, 다시 그 데이터를 조회할 때 수정이 반영된 데이터를 조회하도록 보장하는 것이 인과적 일관성임.<br>
위를 보장하기 위해선 client session 내에서 causal consistency 옵션을 true로 설정해야 함.<br>
```js
const session = await this.connection.startSession({ causalConsistency: true });
```

그리고 4.0 부터는 트랜잭션 기능이 도입되면서, 클라이언트 세션 내에서 트랜잭션을 시작할 수 있게 되었음.<br>
4.2 버전 부터는 샤드 클러스터 환경에서도 트랜잭션을 지원함.<br>

클라이언트 세션은 스레드 세이프하지 않음.<br>
따라서 멀티 스레드 환경에서는 각 스레드마다 별도의 세션을 생성하는 것이 좋음.<br>
(애초에 연결이 종료된 세션은 다시 사용할 수 없기에 세션 스레드 풀 같은 개념은 적합하지 않음.)<br>

그리고 클라이언트 세션은 드라이버 단에서 암묵적으로 생성될 수 있음. (3.6 이상 및 레플리카 및 샤드 모드)<br>
따라서 명시적으로 클라이언트 세션을 생성하지 않더라도, 드라이버 단에서 자동으로 세션이 생성되어 사용될 수 있음.<br>